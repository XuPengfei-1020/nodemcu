<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>501 远程门禁 - 设置页面</title>
  <style>
    .panel-body.active {
      display: block;
    }

    .panel-body {
      display: none;
    }
  </style>
</head>

<body>
  <div class="column col-12 col-xs-12">
    <div class="panel">
      <div class="panel-header text-center">
        <figure class="avatar avatar-lg"><img src="./IOT_48px-min.png" alt="Avatar"></figure>
        <div class="panel-subtitle">控制面板</div>
      </div>
      <nav class="panel-nav">
        <ul class="tab tab-block">
          <li id='status_li' class="tab-item active"><a href="javascript:switchPanel('status_li', 'statusPanel')">状态</a>
          </li>
          <li id='config_li' class="tab-item"><a href="javascript:switchPanel('config_li', 'configPanel')">设置</a></li>
        </ul>
      </nav>
      <div class="panel-body active" id="statusPanel">
        <div class="tile tile-centered">
          <div class="tile-content">
            <div class="tile-title text-bold">模式</div>
            <div class="tile-subtitle" id="wifiMode"></div>
          </div>
        </div>
        <div class="tile tile-centered">
          <div class="tile-content">
            <div class="tile-title text-bold">ap</div>
            <div class="tile-subtitle" id="apInfo"></div>
          </div>
        </div>
        <div class="tile tile-centered">
          <div class="tile-content">
            <div class="tile-title text-bold">wifi</div>
            <div class="tile-subtitle" id="wifiInfo"></div>
          </div>
        </div>
      </div>

      <div class="panel-body" id="configPanel">
        <div class="tile tile-centered">
          <div class="tile-content">
            <div class="tile-title text-bold">修改 wifi 密码</div>
            <div class="form-group">
              <input class="form-input" type="text" id="wifi_ssid" placeholder="wifi名字">
              <input class="form-input" type="text" id="wifi_pass" placeholder="wifi密码">
              <button class="btn btn-success" onclick="save()">保存/重启</button>
            </div>
          </div>
        </div>

        <!-- <div class="tile tile-centered">
          <div class="tile-content">
            <div class="tile-title text-bold">修改 AP 名称和密码</div>
            <div class="form-group">
              <input class="form-input" type="text" id="wifi" placeholder="wifi名字">
              <input class="form-input" type="text" id="password" placeholder="wifi密码">
              <button class="btn btn-success">保存/连接</button>
            </div>
          </div>
        </div> -->
      </div>
    </div>
  </div>
</body>
<script>
  apip = ''
  wifissd = ''
  function switchPanel(label, panel) {
    var active = document.querySelector('.tab-item.active');
    if (active) active.classList.remove('active');
    label = document.querySelector(`#${label}.tab-item`)
    label.classList.add('active');

    active = document.querySelector('.panel-body.active');
    if (active) active.classList.remove('active');
    panel = document.querySelector(`#${panel}.panel-body`)
    panel.classList.add('active');
  }

  function save() {
    var ssid = document.querySelector('#wifi_ssid').value;
    var pass = document.querySelector('#wifi_pass').value;
    if (!ssid) {
      return;
    }

    var xhr = new XMLHttpRequest();
    xhr.open('post', `./wifi_st_config?ssid=${ssid}&pass=${pass}`);
    xhr.onload = function (data) {
      alert(xhr.response)
    }
    xhr.send();
  }

  function getStatus() {
    var xhr = new XMLHttpRequest();
    xhr.open('get', './wifi_status');
    xhr.onload = function (data) {
      var body = xhr.response;
      console.log(body);
      var result = JSON.parse(body);
      document.querySelector('#wifiMode').innerText = (result.mode == 1 ? 'AP' : (result.mode == 2 ? 'STATION' : 'AP & STATION'))
      document.querySelector('#apInfo').innerText = `name: ${result.ap.ssid}, pass: ${result.ap.pass}\nIP: ${result.sta.ip || '未启用'} \nclients:\n ${JSON.stringify(result.ap.clients)}`
      document.querySelector('#wifiInfo').innerText = `name: ${result.sta.ssid}, pass: ${result.sta.pass}\n IP: ${result.sta.ip || '未连接'}`
      apip = result.sta.ip
      wifissd = result.sta.ssid
    }
    xhr.send();
  }
  getStatus()
</script>
<link href="./spectre.min.css" rel="stylesheet" async>
<link href="./spectre-exp.min.css" rel="stylesheet" async>
<link href="./spectre-icons.min.css" rel="stylesheet" async>

</html>